<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MMAM Control Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/inter@5.0.16/latin.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter Variable"', 'Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        };
    </script>
</head>
<body class="bg-slate-100 text-slate-900 font-sans">
    <div id="app" class="min-h-screen flex bg-slate-100 relative">
        <aside class="w-64 bg-slate-900 text-white flex flex-col">
            <div class="px-6 py-5 border-b border-white/10">
                <h1 class="text-xl font-semibold">MMAM</h1>
                <p class="text-xs text-slate-300">media multicast address manager</p>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2 text-sm">
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='dashboard' && 'bg-white/20'" @click="navigate('dashboard')">
                    Dashboard / ダッシュボード
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='flows' && 'bg-white/20'" @click="navigate('flows')">
                    Flows / フロー一覧
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='search' && 'bg-white/20'" @click="navigate('search')">
                    Search / 検索
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='newFlow' && 'bg-white/20'" @click="navigate('newFlow')">
                    New Flow / 新規フロー
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='wizard' && 'bg-white/20'" @click="navigate('wizard')">
                    NMOS Wizard / インポート
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='checker' && 'bg-white/20'" @click="navigate('checker')">
                    Checker / チェック
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='users' && 'bg-white/20'" @click="navigate('users')">
                    Users / ユーザー管理
                </button>
                <button class="w-full text-left px-3 py-2 rounded hover:bg-white/10" :class="currentView==='settings' && 'bg-white/20'" @click="navigate('settings')">
                    Settings / 設定
                </button>
            </nav>
            <div class="px-4 py-4 border-t border-white/10 text-xs">
                <p>{{ currentUser ? currentUser.username : "Guest" }} ({{ currentUser ? currentUser.role : "viewer" }})</p>
                <button class="mt-2 px-3 py-1 bg-white/20 rounded text-sm w-full" @click="logout" v-if="token">Log out</button>
            </div>
        </aside>
        <transition name="toast-fade">
            <div
                v-if="notification"
                class="fixed inset-0 flex items-start justify-center pointer-events-none"
            >
                <div
                    class="mt-16 px-4 py-2 rounded text-sm text-white shadow-lg"
                    :class="notification.type === 'error' ? 'bg-black/70' : 'bg-slate-800/70'"
                >
                    {{ notification.message }}
                </div>
            </div>
        </transition>
        <div class="flex-1 flex flex-col">
            <header class="bg-white shadow px-6 py-4 flex items-center justify-between gap-6">
                <div>
                    <h1 class="text-xl font-semibold">MMAM Dashboard</h1>
                    <p class="text-sm text-slate-500">ST2110 Flow Management</p>
                </div>
                <div class="ml-auto flex items-center gap-4">
                    <div v-if="token" class="text-right">
                        <p class="text-sm font-semibold">
                            {{ currentUser ? currentUser.username : "Logged in" }}
                        </p>
                        <p class="text-xs text-slate-500">
                            {{ currentUser ? currentUser.role : "" }}
                        </p>
                    </div>
                    <button
                        v-if="token"
                        class="px-3 py-2 text-sm rounded border border-slate-300 text-slate-700 hover:bg-slate-50"
                        @click="logout"
                    >
                        Log out
                    </button>
                    <form v-else class="flex items-center gap-2 text-sm" @submit.prevent="login">
                        <input
                            type="text"
                            placeholder="username"
                            class="border rounded px-3 py-2"
                            v-model="loginForm.username"
                        />
                        <input
                            type="password"
                            placeholder="password"
                            class="border rounded px-3 py-2"
                            v-model="loginForm.password"
                        />
                        <button
                            type="submit"
                            class="bg-emerald-600 text-white rounded px-3 py-2"
                        >
                            Log in
                        </button>
                    </form>
                </div>
            </header>
        <main class="flex-1 p-6 overflow-auto space-y-6">
            <template v-if="currentView==='dashboard'">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <section class="bg-white p-4 rounded shadow-lg space-y-3">
                    <h2 class="font-semibold text-lg">Summary</h2>
                    <div class="grid grid-cols-2 gap-3 text-center">
                        <div class="bg-slate-100 rounded p-3">
                            <div class="text-2xl font-bold">{{ summary.total }}</div>
                            <div class="text-xs text-slate-500">Total Flows</div>
                        </div>
                        <div class="bg-slate-100 rounded p-3">
                            <div class="text-2xl font-bold text-emerald-600">{{ summary.active }}</div>
                            <div class="text-xs text-slate-500">Active</div>
                        </div>
                    </div>
                </section>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <section class="bg-white rounded shadow-lg p-4">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="font-semibold text-lg">Flows / フロー一覧</h2>
                        <div class="flex flex-wrap gap-2">
                            <input type="number" min="1" max="500" class="w-20 border rounded px-2 py-1 text-sm bg-white" v-model.number="filters.limit" />
                            <input type="number" min="0" class="w-20 border rounded px-2 py-1 text-sm bg-white" v-model.number="filters.offset" />
                            <select class="border rounded px-2 py-1 text-sm" v-model="filters.sort_by">
                                <option v-for="option in sortFields" :key="option.value" :value="option.value">
                                    {{ option.label }}
                                </option>
                            </select>
                            <select class="border rounded px-2 py-1 text-sm" v-model="filters.sort_order">
                                <option value="desc">Descending</option>
                                <option value="asc">Ascending</option>
                            </select>
                            <button class="px-3 py-1 bg-slate-900 text-white rounded text-sm" @click="refreshFlows">Refresh</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-3 text-xs text-slate-600 mb-3">
                        <span>Page / ページ</span>
                        <input type="number" min="1" class="w-20 border rounded px-2 py-1 bg-white" v-model="pageInput" />
                        <button class="px-3 py-1 rounded text-white bg-slate-900 text-xs hover:bg-slate-800 transition" @click="applyPageInput">Go / 移動</button>
                        <button class="px-3 py-1 rounded text-xs transition"
                            :class="canGoPrevious ? 'bg-slate-900 text-white hover:bg-slate-800 border border-slate-900' : 'bg-slate-100 text-slate-400 border border-slate-200 cursor-not-allowed'"
                            @click="prevPage"
                            :disabled="!canGoPrevious">
                            Previous / 前へ
                        </button>
                        <button class="px-3 py-1 rounded text-xs transition"
                            :class="canGoNext ? 'bg-slate-900 text-white hover:bg-slate-800 border border-slate-900' : 'bg-slate-100 text-slate-400 border border-slate-200 cursor-not-allowed'"
                            @click="nextPage"
                            :disabled="!canGoNext">
                            Next / 次へ
                        </button>
                        <span class="text-[11px] text-slate-500">Current: {{ currentPageNumber }}</span>
                    </div>
                    <div class="space-y-2 max-h-[420px] overflow-auto">
                        <article v-for="flow in flows" :key="flow.flow_id" class="border rounded p-3 flex justify-between items-start">
                            <div>
                                <h3 class="font-semibold flex items-center gap-1">
                                    <span>{{ flow.display_name || flow.flow_id }}</span>
                                    <span v-if="flow.locked" class="text-slate-500 text-base leading-none">⚿</span>
                                </h3>
                                <p v-if="flow.nmos_node_label" class="text-xs text-slate-500 mt-0.5">{{ flow.nmos_node_label }}</p>
                                <p class="text-xs text-slate-500">{{ flow.flow_status }} / {{ flow.availability }}</p>
                                <p class="text-xs text-slate-400">Updated: {{ flow.updated_at }}</p>
                            </div>
                            <div class="flex flex-col gap-1">
                                <button class="text-xs text-slate-600 underline" @click="showFlow(flow.flow_id)">Details</button>
                                <button class="text-xs text-emerald-600 underline" @click="loadFlowForEdit(flow.flow_id)">Edit</button>
                            </div>
                        </article>
                        <p v-if="flows.length === 0" class="text-sm text-slate-500">No flows found.</p>
                    </div>
                </section>
            </div>
            </div>

            <section class="bg-white rounded shadow-lg p-4">
                <h2 class="font-semibold text-lg mb-2">Debug Console</h2>
                <pre class="bg-slate-900 text-slate-100 text-xs rounded p-3 max-h-60 overflow-auto">{{ logs.join("\n") }}</pre>
            </section>
            </template>

            <template v-else-if="currentView==='flows'">
                <section class="bg-white rounded shadow-lg p-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-lg">Flows / フロー一覧</h2>
                        <div class="flex items-center gap-2 text-sm">
                            <label>limit <input type="number" min="1" max="500" class="w-20 border rounded px-2 py-1 bg-white" v-model.number="filters.limit" /></label>
                            <label>offset <input type="number" min="0" class="w-20 border rounded px-2 py-1 bg-white" v-model.number="filters.offset" /></label>
                            <label class="flex items-center gap-1">
                                sort
                                <select class="border rounded px-2 py-1" v-model="filters.sort_by">
                                    <option v-for="option in sortFields" :key="option.value" :value="option.value">
                                        {{ option.label }}
                                    </option>
                                </select>
                            </label>
                            <label class="flex items-center gap-1">
                                order
                                <select class="border rounded px-2 py-1" v-model="filters.sort_order">
                                    <option value="desc">Descending</option>
                                    <option value="asc">Ascending</option>
                                </select>
                            </label>
                            <button class="px-3 py-1 bg-slate-900 text-white rounded" @click="refreshFlows">Refresh</button>
                        </div>
                    </div>
                    <div class="flex flex-wrap items-center gap-3 text-xs text-slate-600">
                        <div class="flex items-center gap-2">
                            <span>Page / ページ</span>
                            <input type="number" min="1" class="w-20 border rounded px-2 py-1 bg-white" v-model="pageInput" />
                            <button class="px-3 py-1 rounded text-white bg-slate-900 hover:bg-slate-800 transition" @click="applyPageInput">Go / 移動</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="px-3 py-1 rounded transition"
                                :class="canGoPrevious ? 'bg-slate-900 text-white hover:bg-slate-800 border border-slate-900' : 'bg-slate-100 text-slate-400 border border-slate-200 cursor-not-allowed'"
                                @click="prevPage"
                                :disabled="!canGoPrevious">
                                Previous / 前へ
                            </button>
                            <button class="px-3 py-1 rounded transition"
                                :class="canGoNext ? 'bg-slate-900 text-white hover:bg-slate-800 border border-slate-900' : 'bg-slate-100 text-slate-400 border border-slate-200 cursor-not-allowed'"
                                @click="nextPage"
                                :disabled="!canGoNext">
                                Next / 次へ
                            </button>
                        </div>
                        <span>Current page: {{ currentPageNumber }}</span>
                        <span>Showing {{ filters.offset + 1 }} - {{ filters.offset + flows.length }}</span>
                    </div>
                    <div class="overflow-auto">
                        <table class="w-full text-sm border border-slate-200">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="px-3 py-2 text-left">Display Name</th>
                                    <th class="px-3 py-2 text-left">flow_id</th>
                                    <th class="px-3 py-2 text-left">status</th>
                                    <th class="px-3 py-2 text-left">Source A</th>
                                    <th class="px-3 py-2 text-left">Multicast A</th>
                                    <th class="px-3 py-2 text-left">Source B</th>
                                    <th class="px-3 py-2 text-left">Multicast B</th>
                                    <th class="px-3 py-2 text-left">Updated At</th>
                                    <th class="px-3 py-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="flow in flows" :key="flow.flow_id" class="border-t hover:bg-slate-50">
                                    <td class="px-3 py-2">
                                        <div class="font-semibold flex items-center gap-1">
                                            <span>{{ flow.display_name || '-' }}</span>
                                            <span v-if="flow.locked" class="text-slate-500 text-base leading-none">⚿</span>
                                        </div>
                                        <div v-if="flow.nmos_node_label" class="text-xs text-slate-500 mt-0.5">{{ flow.nmos_node_label }}</div>
                                    </td>
                                    <td class="px-3 py-2 text-xs">
                                        <div class="flex items-center gap-2">
                                            <span class="font-mono break-all">{{ flow.flow_id }}</span>
                                            <button
                                                class="text-[11px] px-2 py-1 border rounded text-slate-600 hover:bg-slate-100"
                                                @click="copyToClipboard(flow.flow_id)"
                                            >
                                                Copy
                                            </button>
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 text-xs">{{ flow.flow_status }}/{{ flow.availability }}</td>
                                    <td class="px-3 py-2 text-xs font-mono">{{ flow.source_addr_a }}:{{ flow.source_port_a }}</td>
                                    <td class="px-3 py-2 text-xs font-mono">{{ flow.multicast_addr_a }}:{{ flow.group_port_a }}</td>
                                    <td class="px-3 py-2 text-xs font-mono">{{ flow.source_addr_b }}:{{ flow.source_port_b }}</td>
                                    <td class="px-3 py-2 text-xs font-mono">{{ flow.multicast_addr_b }}:{{ flow.group_port_b }}</td>
                                    <td class="px-3 py-2 text-xs">{{ flow.updated_at }}</td>
                                    <td class="px-3 py-2 text-xs">
                                        <div class="flex flex-col gap-1">
                                            <button class="text-slate-600 underline" @click="showFlow(flow.flow_id)">Details</button>
                                            <button class="text-emerald-600 underline" @click="loadFlowForEdit(flow.flow_id)">Edit</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="flows.length === 0">
                                    <td colspan="9" class="text-center py-4 text-slate-500">No flows found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='search'">
                <div class="space-y-6">
                    <section class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div>
                            <h2 class="font-semibold text-lg">Quick Search / 簡易検索</h2>
                            <p class="text-xs text-slate-500">Search all text fields with partial match keywords.</p>
                        </div>
                        <div class="flex flex-col gap-3 md:flex-row md:items-end md:gap-4 text-sm">
                            <label class="flex-1 flex flex-col gap-1 text-slate-600">
                                Keyword / キーワード
                                <input type="text" class="border rounded px-3 py-2" v-model="quickSearch.term" placeholder="studio / 239.10.0.1" />
                            </label>
                            <label class="flex flex-col gap-1 text-slate-600">
                                Limit
                                <input type="number" min="1" max="200" class="border rounded px-3 py-2" v-model.number="quickSearch.limit" />
                            </label>
                            <button class="bg-slate-900 text-white rounded px-4 py-2 md:self-end" @click="runQuickSearch">
                                Search
                            </button>
                        </div>
                    </section>

                    <section class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div class="flex flex-col gap-2 md:flex-row md:items-start md:justify-between">
                            <div>
                                <h2 class="font-semibold text-lg">Advanced Search / 詳細検索</h2>
                                <p class="text-xs text-slate-500">Enter conditions per field; numeric and datetime values support ranges.</p>
                            </div>
                            <button
                                class="text-xs text-slate-600 border rounded px-3 py-1 self-start"
                                @click="toggleAdvancedCollapse"
                            >
                                {{ advancedCollapsed ? '▼ Expand / 展開' : '▲ Collapse / 縮小' }}
                            </button>
                        </div>
                        <div class="grid gap-3" v-show="!advancedCollapsed">
                            <div class="flex flex-col md:flex-row md:items-end gap-3 text-sm text-slate-600">
                                <label class="flex flex-col gap-1 text-slate-600 w-full md:w-48 lg:w-40">
                                    Limit
                                    <input
                                        type="number"
                                        min="1"
                                        max="200"
                                        class="border rounded px-3 py-2"
                                        v-model.number="advancedSearch.limit"
                                    />
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-500">
                                <label>Display Name
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.display_name" placeholder="ex. Studio" />
                                </label>
                                <label>Flow ID
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.flow_id" placeholder="UUID" />
                                </label>
                                <label>NMOS Node ID
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.nmos_node_id" placeholder="UUID" />
                                </label>
                                <label>Source Address A
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.source_addr_a" />
                                </label>
                                <label>Source Address B
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.source_addr_b" />
                                </label>
                                <label>Multicast Address A
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.multicast_addr_a" />
                                </label>
                                <label>Multicast Address B
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.multicast_addr_b" />
                                </label>
                                <label>Transport Protocol
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.transport_protocol" />
                                </label>
                                <label>Label / Alias
                                    <input class="w-full border rounded px-3 py-2" v-model="advancedSearch.alias1" placeholder="Alias contains" />
                                </label>
                                <label>Status
                                    <select class="w-full border rounded px-3 py-2" v-model="advancedSearch.flow_status">
                                        <option value="">Any / 指定なし</option>
                                        <option v-for="status in flowStatusOptions" :key="status" :value="status">
                                            {{ status }}
                                        </option>
                                    </select>
                                </label>
                                <label>Availability
                                    <select class="w-full border rounded px-3 py-2" v-model="advancedSearch.availability">
                                        <option value="">Any / 指定なし</option>
                                        <option v-for="state in availabilityOptions" :key="state" :value="state">
                                            {{ state }}
                                        </option>
                                    </select>
                                </label>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-slate-500">
                                <div>
                                    <p class="font-semibold mb-2 text-slate-600">Port Range / ポート範囲</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label>Src A Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.source_port_a_min" />
                                        </label>
                                        <label>Src A Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.source_port_a_max" />
                                        </label>
                                        <label>Src B Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.source_port_b_min" />
                                        </label>
                                        <label>Src B Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.source_port_b_max" />
                                        </label>
                                        <label>Group A Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.group_port_a_min" />
                                        </label>
                                        <label>Group A Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.group_port_a_max" />
                                        </label>
                                        <label>Group B Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.group_port_b_min" />
                                        </label>
                                        <label>Group B Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.group_port_b_max" />
                                        </label>
                                        <label>IS-04 Port Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.nmos_is04_port_min" />
                                        </label>
                                        <label>IS-04 Port Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.nmos_is04_port_max" />
                                        </label>
                                        <label>IS-05 Port Min
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.nmos_is05_port_min" />
                                        </label>
                                        <label>IS-05 Port Max
                                            <input type="number" class="w-full border rounded px-2 py-1" v-model.number="advancedSearch.nmos_is05_port_max" />
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <p class="font-semibold mb-1 text-slate-600">Date Range</p>
                                    <p class="text-[11px] text-slate-500 mb-2">Format: YYYY-MM-DDTHH:MM (24h)</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label>Updated From
                                            <input type="datetime-local" lang="en-CA" step="1" placeholder="YYYY-MM-DDTHH:MM" class="w-full border rounded px-2 py-1" v-model="advancedSearch.updated_at_min" />
                                        </label>
                                        <label>Updated To
                                            <input type="datetime-local" lang="en-CA" step="1" placeholder="YYYY-MM-DDTHH:MM" class="w-full border rounded px-2 py-1" v-model="advancedSearch.updated_at_max" />
                                        </label>
                                        <label>Created From
                                            <input type="datetime-local" lang="en-CA" step="1" placeholder="YYYY-MM-DDTHH:MM" class="w-full border rounded px-2 py-1" v-model="advancedSearch.created_at_min" />
                                        </label>
                                        <label>Created To
                                            <input type="datetime-local" lang="en-CA" step="1" placeholder="YYYY-MM-DDTHH:MM" class="w-full border rounded px-2 py-1" v-model="advancedSearch.created_at_max" />
                                        </label>
                                    </div>
                                    <div class="mt-3 flex items-center gap-3">
                                        <label class="flex items-center gap-2 text-xs text-slate-600">
                                            <input type="checkbox" v-model="advancedSearch.include_unused" />
                                            Include unused / 論理削除を含む
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button class="bg-slate-900 text-white rounded px-4 py-2 text-sm" @click="runAdvancedSearch">Advanced Search</button>
                                <button class="px-4 py-2 border rounded text-sm" @click="resetAdvancedSearch">Reset</button>
                            </div>
                        </div>
                        <p v-if="advancedCollapsed" class="text-xs text-slate-500">Advanced search form is hidden. Expand to edit conditions.</p>
                    </section>
                </div>
                <section class="bg-white rounded shadow-lg p-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">Results / 検索結果</h3>
                            <p class="text-xs text-slate-500">Mode: {{ searchMode || 'not started' }}</p>
                        </div>
                        <button class="text-sm text-slate-600 underline" @click="refreshFlows">Reload latest flows</button>
                    </div>
                    <div class="overflow-auto">
                        <table class="w-full text-sm border border-slate-200 min-w-[760px]">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="px-3 py-2 text-left">Display Name</th>
                                    <th class="px-3 py-2 text-left">Flow ID</th>
                                    <th class="px-3 py-2 text-left">Status</th>
                                    <th class="px-3 py-2 text-left">Source A</th>
                                    <th class="px-3 py-2 text-left">Multicast A</th>
                                    <th class="px-3 py-2 text-left">Updated</th>
                                    <th class="px-3 py-2 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="flow in searchResults" :key="flow.flow_id" class="border-t hover:bg-slate-50">
                                    <td class="px-3 py-2">
                                        <div class="font-semibold flex items-center gap-1">
                                            <span>{{ flow.display_name || '-' }}</span>
                                            <span v-if="flow.locked" class="text-slate-500 text-base leading-none">⚿</span>
                                        </div>
                                        <div v-if="flow.nmos_node_label" class="text-xs text-slate-500 mt-0.5">{{ flow.nmos_node_label }}</div>
                                    </td>
                                    <td class="px-3 py-2 text-xs">
                                        <div class="flex items-center gap-2">
                                            <span class="font-mono break-all">{{ flow.flow_id }}</span>
                                            <button
                                                class="text-[11px] px-2 py-1 border rounded text-slate-600 hover:bg-slate-100"
                                                @click="copyToClipboard(flow.flow_id)"
                                            >
                                                Copy
                                            </button>
                                        </div>
                                    </td>
                                    <td class="px-3 py-2 text-xs">{{ flow.flow_status }} / {{ flow.availability }}</td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.source_addr_a }}:{{ flow.source_port_a }}</td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.multicast_addr_a }}:{{ flow.group_port_a }}</td>
                                    <td class="px-3 py-2 text-xs">{{ flow.updated_at }}</td>
                                    <td class="px-3 py-2 text-xs">
                                        <div class="flex flex-col gap-1">
                                            <button class="text-slate-600 underline" @click="showFlow(flow.flow_id)">Details</button>
                                            <button class="text-emerald-600 underline" @click="loadFlowForEdit(flow.flow_id)">Edit</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="searchResults.length === 0">
                                    <td colspan="7" class="text-center py-4 text-slate-500">No results / 検索結果がありません。</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='newFlow'">
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="font-semibold text-lg">
                                {{ editingFlowId ? 'Flow Update / Edit Flow' : 'Create Flow (Manual)' }}
                            </h2>
                            <p v-if="editingFlowId" class="text-xs text-slate-500">Editing: {{ editingFlowId }}</p>
                        </div>
                        <div class="flex flex-col gap-2 items-end">
                            <div class="flex items-center gap-2" v-if="editingFlowId">
                                <button
                                    class="px-3 py-1 text-xs rounded border flex items-center gap-1"
                                    :class="newFlow.locked ? 'border-red-300 text-red-600 bg-red-50' : 'border-emerald-300 text-emerald-600 bg-emerald-50'"
                                    :disabled="!lockToggleAllowed || lockToggleLoading"
                                    @click="toggleFlowLock"
                                >
                                    <span v-if="newFlow.locked" class="flex items-center gap-1">
                                        <span class="text-slate-500 text-base leading-none">⚿</span>
                                        <span>Locked</span>
                                    </span>
                                    <span v-else>Unlocked</span>
                                </button>
                                <span v-if="!lockToggleAllowed" class="text-[11px] text-slate-500">insufficient role</span>
                                <button
                                    class="px-3 py-1 border rounded text-xs"
                                    :disabled="nmos.checking"
                                    @click="checkNmos(editingFlowId)"
                                >
                                    NMOS Check
                                </button>
                                <button
                                    class="px-3 py-1 text-xs rounded border"
                                    :class="canApplyNmos(editingFlowId) ? 'border-emerald-500 text-emerald-600' : 'text-slate-400 border-slate-200 cursor-not-allowed'"
                                    :disabled="!canApplyNmos(editingFlowId) || nmos.applying"
                                    @click="openNmosApplyDialog(editingFlowId)"
                                >
                                    NMOS Sync
                                </button>
                                <span v-if="canApplyNmos(editingFlowId)" class="text-[11px] text-red-600">
                                    差分: {{ nmosDiffSummary(editingFlowId) }}
                                </span>
                            </div>
                            <div class="flex gap-3">
                                <button class="px-3 py-2 border rounded text-sm" @click="resetFlowForm">Reset</button>
                                <button
                                    class="px-4 py-2 bg-emerald-600 text-white rounded text-sm disabled:opacity-50"
                                    @click="submitFlow"
                                    :disabled="editingFlowId && newFlow.locked"
                                >
                                    {{ editingFlowId ? 'Update' : 'Create' }}
                                </button>
                                <button
                                    v-if="editingFlowId"
                                    class="px-4 py-2 bg-red-500 text-white rounded text-sm disabled:opacity-50"
                                    :disabled="newFlow.locked"
                                    @click="deleteFlow(editingFlowId)"
                                >
                                    Delete Flow
                                </button>
                            </div>
                        </div>
                    </div>
                    <p v-if="newFlow.locked" class="text-xs text-red-600">
                        このフローはロック中です。フィールド編集や削除はできませんが、NMOS Check は実行できます（NMOS Sync は解除後に可能）。
                    </p>
                    <p v-if="nmos.error && nmos.targetFlowId === editingFlowId" class="text-xs text-red-600">{{ nmos.error }}</p>
                    <fieldset :disabled="newFlow.locked" class="space-y-4 border-0 p-0 m-0">
                        <div v-for="group in fieldGroups" :key="group.title" class="border rounded p-4">
                            <h3 class="font-semibold text-base mb-3">{{ group.title }}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label v-for="field in group.fields" :key="field.key" class="text-xs text-slate-500 space-y-1">
                                    {{ field.label }}
                                    <template v-if="field.type === 'textarea'">
                                        <textarea
                                            :class="['w-full border rounded px-3 py-2', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            rows="field.rows || 3"
                                            v-model="newFlow[field.key]"
                                        ></textarea>
                                    </template>
                                    <template v-else-if="field.type === 'select'">
                                        <select
                                            :class="['w-full border rounded px-3 py-2', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            v-model="newFlow[field.key]"
                                        >
                                            <option v-for="option in field.options" :key="option" :value="option">{{ option }}</option>
                                        </select>
                                    </template>
                                    <template v-else-if="field.key === 'flow_id'">
                                        <input
                                            type="text"
                                            :class="['w-full border rounded px-3 py-2 disabled:bg-slate-100 disabled:text-slate-500', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            v-model="newFlow[field.key]"
                                            :disabled="newFlow.data_source === 'manual'"
                                            placeholder="Auto assigned / NMOS Flow ID"
                                        />
                                        <span class="text-[10px] text-slate-500 block">
                                            Auto-generated for manual entries; editable only via NMOS/RDS imports.
                                        </span>
                                    </template>
                                    <template v-else>
                                        <input
                                            v-if="field.type === 'number'"
                                            type="number"
                                            :class="['w-full border rounded px-3 py-2', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            v-model.number="newFlow[field.key]"
                                        />
                                        <input
                                            v-else
                                            type="text"
                                            :class="['w-full border rounded px-3 py-2', isNmosDiff(field.key, editingFlowId) ? 'border-red-500 ring-1 ring-red-400' : '']"
                                            v-model="newFlow[field.key]"
                                        />
                                    </template>
                                </label>
                            </div>
                        </div>
                    </fieldset>
                    <p class="text-xs text-slate-500">Designed for future NMOS / RDS auto-fill wizards.</p>
                </section>
            </template>

            <template v-else-if="currentView==='wizard'">
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="font-semibold text-lg">NMOS Import Wizard</h2>
                            <p class="text-xs text-slate-500">Fetch flows from an NMOS IS-04 Node endpoint.</p>
                        </div>
                        <span class="text-xs text-slate-400">
                            {{ wizard.node ? 'Node: ' + (wizard.node.label || wizard.node.id || '-') : '' }}
                        </span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                        <label class="text-slate-600">
                            IS-04 Base URL (up to /x-nmos/)
                            <div class="flex gap-2">
                                <input type="text" class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.is04BaseUrl" placeholder="http://example:8080/x-nmos/" />
                                <button type="button" class="px-2 py-1 mt-1 text-xs border rounded" @click="copyIs04ToIs05">Copy →</button>
                            </div>
                        </label>
                        <label class="text-slate-600">
                            IS-05 Base URL (up to /x-nmos/)
                            <input type="text" class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.is05BaseUrl" placeholder="http://example:8080/x-nmos/" />
                        </label>
                        <label class="text-slate-600">
                            IS-04 Version
                            <select class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.is04Version">
                                <option v-for="version in wizard.is04Versions" :key="version" :value="version">
                                    {{ version }}
                                </option>
                            </select>
                        </label>
                        <label class="text-slate-600">
                            IS-05 Version
                            <select class="w-full border rounded px-3 py-2 mt-1" v-model="wizard.is05Version">
                                <option v-for="version in wizard.is05Versions" :key="version" :value="version">
                                    {{ version }}
                                </option>
                            </select>
                        </label>
                        <div class="flex items-end md:col-span-2">
                            <button class="px-4 py-2 bg-slate-900 text-white rounded w-full" @click="fetchNmosFlows" :disabled="wizard.loading">
                                {{ wizard.loading ? 'Loading...' : 'Fetch Flows' }}
                            </button>
                        </div>
                    </div>
                    <p v-if="wizard.error" class="text-sm text-red-600">{{ wizard.error }}</p>
                    <div v-if="wizard.node" class="text-xs text-slate-500 bg-slate-100 rounded p-3">
                        <p>Node ID: <span class="font-mono">{{ wizard.node.id }}</span></p>
                        <p v-if="wizard.node.description">{{ wizard.node.description }}</p>
                    </div>
                </section>
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg">Discovered Flows</h3>
                            <p class="text-xs text-slate-500">Select flows to import into MMAM.</p>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-slate-600">
                            <span>Selected: {{ wizardSelectedCount }}</span>
                            <button
                                class="px-3 py-1 bg-emerald-600 text-white rounded"
                                :disabled="wizardSelectedCount === 0 || wizard.importing"
                                @click="importSelectedFlows"
                            >
                                {{ wizard.importing ? 'Importing...' : 'Import Selected' }}
                            </button>
                        </div>
                    </div>
                    <div class="overflow-auto">
                        <table class="w-full text-sm border border-slate-200">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="px-3 py-2 text-center">
                                        <label class="inline-flex items-center justify-center">
                                            <input
                                                type="checkbox"
                                                :checked="wizardAllSelected"
                                                :indeterminate="wizardIndeterminate"
                                                @change="toggleWizardSelectAll($event.target.checked)"
                                            />
                                            <span class="sr-only">Select all</span>
                                        </label>
                                    </th>
                                    <th class="px-3 py-2 text-left">Label</th>
                                    <th class="px-3 py-2 text-left">Flow ID</th>
                                    <th class="px-3 py-2 text-left">Sender ID</th>
                                    <th class="px-3 py-2 text-left">Device ID</th>
                                    <th class="px-3 py-2 text-left">Format</th>
                                    <th class="px-3 py-2 text-left">Transport</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="flow in wizard.flows" :key="flow.nmos_flow_id" class="border-t hover:bg-slate-50">
                                    <td class="px-3 py-2 text-center">
                                        <input
                                            type="checkbox"
                                            :checked="isWizardFlowSelected(flow.nmos_flow_id)"
                                            @change="toggleWizardSelection(flow.nmos_flow_id, $event.target.checked)"
                                        />
                                    </td>
                                    <td class="px-3 py-2">
                                        <p class="font-semibold">{{ flow.label }}</p>
                                        <p class="text-xs text-slate-500">{{ flow.description }}</p>
                                    </td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.nmos_flow_id }}</td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.nmos_sender_id || '-' }}</td>
                                    <td class="px-3 py-2 font-mono text-xs">{{ flow.nmos_device_id || '-' }}</td>
                                    <td class="px-3 py-2 text-xs">{{ flow.format || '-' }}</td>
                                    <td class="px-3 py-2 text-xs">{{ flow.sender_transport || '-' }}</td>
                                </tr>
                                <tr v-if="wizard.flows.length === 0">
                                    <td colspan="7" class="text-center py-4 text-slate-500">
                                        {{ wizard.loading ? 'Fetching flows...' : 'No flows loaded yet.' }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='checker'">
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex flex-wrap gap-2 text-sm">
                        <button
                            v-for="tab in checkerTabs"
                            :key="tab.key"
                            class="px-4 py-2 rounded border"
                            :class="currentCheckerTab===tab.key ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-slate-600 border-slate-300'"
                            @click="setCheckerTab(tab.key)"
                        >
                            {{ tab.label }}
                        </button>
                    </div>
                    <div v-if="currentCheckerTab==='collisions'" class="space-y-4">
                        <div class="flex flex-col md:flex-row md:items-center gap-3">
                            <div>
                                <h2 class="font-semibold text-lg">Collision Check</h2>
                                <p class="text-xs text-slate-500">
                                    Find duplicate multicast destinations across flows. Only logged-in editors/admins can run this check.
                                </p>
                            </div>
                            <div class="flex gap-2">
                                <button
                                    class="px-4 py-2 bg-slate-900 text-white rounded text-sm disabled:opacity-50"
                                    @click="runCollisionCheck"
                                    :disabled="checkerLoading"
                                >
                                    {{ checkerLoading ? 'Checking...' : 'Run Check' }}
                                </button>
                            </div>
                        </div>
                        <div v-if="checkerResults.collisions">
                            <p class="text-xs text-slate-500">Last executed: {{ checkerResults.collisions.fetchedAt }}</p>
                            <div v-for="group in checkerResults.collisions.results" :key="group.field" class="border rounded p-4 mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <h3 class="font-semibold text-base">{{ group.label }}</h3>
                                    <span class="text-xs text-slate-500">
                                        Duplicates: {{ group.entries.length }}
                                    </span>
                                </div>
                                <div v-if="group.entries.length > 0" class="overflow-auto">
                                    <table class="w-full text-xs border border-slate-200">
                                        <thead class="bg-slate-100 text-slate-600">
                                            <tr>
                                                <th class="px-3 py-2 text-left">Value</th>
                                                <th class="px-3 py-2 text-left">Count</th>
                                                <th class="px-3 py-2 text-left">Flows</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="entry in group.entries" :key="entry.value" class="border-t">
                                                <td class="px-3 py-2 font-mono break-all">{{ entry.value }}</td>
                                                <td class="px-3 py-2">{{ entry.count }}</td>
                                                <td class="px-3 py-2 text-xs">
                                                    <ul class="space-y-1">
                                                        <li
                                                            v-for="flow in entry.flows"
                                                            :key="flow.flow_id"
                                                            class="border-b border-slate-200 pb-1 last:border-none last:pb-0"
                                                        >
                                                            <div class="font-mono text-[11px] break-all flex items-center gap-2">
                                                                <span>ID: {{ flow.flow_id }}</span>
                                                                <button
                                                                    class="text-[10px] px-2 py-0.5 border rounded text-slate-600 hover:bg-slate-100"
                                                                    @click="copyToClipboard(flow.flow_id)"
                                                                >
                                                                    Copy
                                                                </button>
                                                            </div>
                                                            <div class="text-[11px] text-slate-600">
                                                                Name: {{ flow.display_name || '-' }}
                                                            </div>
                                                            <div class="text-[11px] text-slate-500">
                                                                Node: {{ flow.nmos_node_label || '-' }}
                                                            </div>
                                                        </li>
                                                    </ul>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <p v-else class="text-xs text-slate-500">No duplicates found.</p>
                            </div>
                        </div>
                        <p v-else class="text-xs text-slate-500">No check has been executed yet.</p>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='users'">
                <section class="bg-white rounded shadow-lg p-4 space-y-4">
                    <div class="flex items-center justify-between">
                        <h2 class="font-semibold text-lg">Users / ユーザー管理</h2>
                        <button class="px-3 py-1 bg-slate-900 text-white rounded text-sm" @click="fetchUsers">Reload</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <label class="text-xs text-slate-500">Username
                            <input class="w-full border rounded px-3 py-2" v-model="newUser.username" />
                        </label>
                        <label class="text-xs text-slate-500">Password
                            <input type="password" class="w-full border rounded px-3 py-2" v-model="newUser.password" />
                        </label>
                        <label class="text-xs text-slate-500">Role
                            <select class="w-full border rounded px-3 py-2" v-model="newUser.role">
                                <option value="viewer">viewer</option>
                                <option value="editor">editor</option>
                                <option value="admin">admin</option>
                            </select>
                        </label>
                    </div>
                    <p class="text-[11px] text-slate-500">
                        Username must be 3-64 chars, password 4-128 chars (per API validation).
                    </p>
                    <button class="px-4 py-2 bg-emerald-600 text-white rounded text-sm" @click="createUser">Add User</button>
                    <div class="overflow-auto">
                        <table class="w-full text-sm border border-slate-200">
                            <thead class="bg-slate-100 text-slate-600">
                                <tr>
                                    <th class="px-3 py-2 text-left">Username</th>
                                    <th class="px-3 py-2 text-left">Role</th>
                                    <th class="px-3 py-2 text-left">Created At</th>
                                    <th class="px-3 py-2 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="user in users" :key="user.username" class="border-t">
                                    <td class="px-3 py-2 font-semibold">{{ user.username }}</td>
                                    <td class="px-3 py-2">
                                        <select class="border rounded px-2 py-1 text-xs" v-model="user.role" @change="updateUserInfo(user)">
                                            <option value="viewer">viewer</option>
                                            <option value="editor">editor</option>
                                            <option value="admin">admin</option>
                                        </select>
                                    </td>
                                    <td class="px-3 py-2 text-xs">{{ user.created_at }}</td>
                                    <td class="px-3 py-2 text-xs text-center">
                                        <button class="text-emerald-600 underline mr-3" @click="updateUserInfo(user)">Save</button>
                                        <button class="text-red-500 underline" @click="deleteUser(user.username)">Delete</button>
                                    </td>
                                </tr>
                                <tr v-if="users.length === 0">
                                    <td colspan="4" class="text-center py-4 text-slate-500">No users found.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </template>

            <template v-else-if="currentView==='settings'">
                <div class="space-y-4">
                    <section class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="font-semibold text-lg">Connection Settings</h2>
                            <button class="px-3 py-1 bg-slate-900 text-white rounded text-sm" @click="loadBaseUrl">Reload</button>
                        </div>
                        <label class="text-sm text-slate-500">API Base URL
                            <input type="text" v-model="baseUrl" class="w-full border rounded px-3 py-2 mt-1" placeholder="http://10.59.100.111:8080" />
                        </label>
                        <div class="flex gap-2">
                            <button class="px-3 py-2 bg-slate-900 text-white rounded text-sm" @click="saveBaseUrl">Save</button>
                            <button class="px-3 py-2 border rounded text-sm" @click="loadBaseUrl">Reset</button>
                        </div>
                        <p class="text-xs text-slate-500">Stored in browser local storage.</p>
                        <div class="border-t pt-4 space-y-2">
                            <h3 class="font-semibold text-base">Login</h3>
                            <p class="text-xs text-slate-500">Current: {{ currentUser ? currentUser.username : "Not signed in" }}</p>
                            <div v-if="!token" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <input type="text" v-model="loginForm.username" placeholder="username" class="border rounded px-3 py-2" />
                                <input type="password" v-model="loginForm.password" placeholder="password" class="border rounded px-3 py-2" />
                                <button class="bg-emerald-600 text-white rounded px-3 py-2" @click="login">Log in</button>
                            </div>
                            <div v-else class="text-xs text-slate-500">Already logged in. Log out to re-authenticate.</div>
                        </div>
                    </section>

                    <section class="bg-white rounded shadow-lg p-4 space-y-4">
                        <div class="flex items-center justify-between">
                            <h2 class="font-semibold text-lg">Application Settings</h2>
                            <button class="px-3 py-1 bg-slate-900 text-white rounded text-sm" @click="fetchSettings">Reload</button>
                        </div>
                        <div class="space-y-2">
                            <template v-for="(value, key) in settings" :key="key">
                                <div
                                    v-if="key !== 'flow_lock_role'"
                                    class="border rounded p-3 flex items-center justify-between"
                                >
                                    <div>
                                        <p class="text-sm font-semibold">{{ key }}</p>
                                        <p class="text-xs text-slate-500">Current value: {{ value }}</p>
                                    </div>
                                    <button class="px-3 py-1 border rounded text-sm" @click="updateSetting(key, value === true ? false : true)" v-if="typeof value === 'boolean'">
                                        {{ value ? 'Disable' : 'Enable' }}
                                    </button>
                                    <button class="px-3 py-1 border rounded text-sm" v-else disabled>Read only</button>
                                </div>
                            </template>
                            <div class="border rounded p-3 space-y-2">
                                <div>
                                    <p class="text-sm font-semibold">Flow Lock Role</p>
                                    <p class="text-xs text-slate-500">Select who can toggle flow locks.</p>
                                </div>
                                <label class="flex items-center gap-2 text-sm text-slate-600">
                                    <input
                                        type="radio"
                                        value="admin"
                                        v-model="settings.flow_lock_role"
                                        @change="updateSetting('flow_lock_role', settings.flow_lock_role)"
                                    />
                                    Admin only
                                </label>
                                <label class="flex items-center gap-2 text-sm text-slate-600">
                                    <input
                                        type="radio"
                                        value="editor"
                                        v-model="settings.flow_lock_role"
                                        @change="updateSetting('flow_lock_role', settings.flow_lock_role)"
                                    />
                                    Editor or higher
                                </label>
                            </div>
                        </div>
                    </section>

                    <section class="bg-white rounded shadow-lg p-4 space-y-3 border border-red-100">
                        <h2 class="font-semibold text-lg text-red-600">Hard Delete Flow</h2>
                        <p class="text-xs text-red-500">
                            Completely deletes the record with the specified flow_id from the database. Calls the
                            /api/flows/&lt;flow_id&gt;/hard endpoint. Cannot be restored.
                        </p>
                        <div class="flex flex-col md:flex-row gap-3">
                            <input
                                type="text"
                                class="flex-1 border rounded px-3 py-2 text-sm font-mono"
                                placeholder="UUID flow_id"
                                v-model="hardDeleteFlowId"
                            />
                            <button
                                class="px-4 py-2 bg-red-600 text-white rounded text-sm disabled:opacity-50"
                                :disabled="!hardDeleteFlowId"
                                @click="hardDeleteFlow"
                            >
                                Permanently Delete
                            </button>
                        </div>
                    </section>

                    <section class="bg-white rounded shadow-lg p-4 space-y-3">
                        <h2 class="font-semibold text-lg">Flow Data Import / Export</h2>
                        <div class="flex flex-col md:flex-row gap-3 items-start md:items-center">
                            <button
                                class="px-4 py-2 bg-slate-900 text-white rounded text-sm disabled:opacity-50"
                                @click="exportFlows"
                                :disabled="!token"
                            >
                                Download JSON
                            </button>
                            <label class="flex items-center gap-2 text-sm text-slate-600 cursor-pointer">
                                <span class="px-3 py-2 border rounded bg-white">Choose JSON</span>
                                <input
                                    type="file"
                                    accept="application/json"
                                    class="hidden"
                                    @change="handleImportFile"
                                    ref="flowImportInput"
                                />
                                <span class="text-xs text-slate-500">
                                    {{ importFile ? importFile.name : 'No file selected' }}
                                </span>
                            </label>
                            <button
                                class="px-4 py-2 bg-emerald-600 text-white rounded text-sm disabled:opacity-50"
                                :disabled="!importFile || importingFlows"
                                @click="importFlows"
                            >
                                {{ importingFlows ? 'Uploading...' : 'Import JSON' }}
                            </button>
                        </div>
                        <p class="text-xs text-slate-500">
                            Admin only. Locked flows are skipped during import.
                        </p>
                    </section>
                </div>
            </template>

            <template v-else>
                <section class="bg-white rounded shadow-lg p-6 text-sm text-slate-500">
                    This section is not implemented yet.
                </section>
            </template>

            <div
                v-if="nmos.applyVisible && nmos.result"
                class="fixed inset-0 bg-black/60 flex items-center justify-center z-50"
            >
                <div class="bg-white rounded shadow-lg w-full max-w-2xl max-h-[80vh] overflow-auto">
                    <div class="flex justify-between items-center px-6 py-4 border-b">
                        <h3 class="text-lg font-semibold">NMOS反映</h3>
                        <button class="text-sm text-slate-500" @click="closeNmosApplyDialog">Close</button>
                    </div>
                    <div class="p-6 space-y-3 text-sm">
                        <p>Flow: <span class="font-mono">{{ nmos.result.flow_id }}</span></p>
                        <p class="text-xs text-slate-500">Select the fields to overwrite with the latest NMOS values.</p>
                        <div class="max-h-64 overflow-auto border rounded divide-y">
                            <label
                                v-for="field in (nmos.result.comparable_fields || [])"
                                :key="field"
                                class="flex items-start gap-3 px-4 py-2 text-xs text-slate-600"
                            >
                                <input type="checkbox" class="mt-1" :value="field" v-model="nmos.applySelections" />
                                <div class="flex-1">
                                    <p class="font-semibold">{{ field }}</p>
                                    <p class="text-[11px] text-slate-500">
                                        Current: {{ nmosDiffValue(field)?.current ?? '—' }}
                                    </p>
                                    <p class="text-[11px] text-emerald-600">
                                        NMOS: {{ nmosDiffValue(field)?.nmos ?? nmos.result.snapshot[field] ?? '—' }}
                                    </p>
                                </div>
                            </label>
                        </div>
                        <div class="flex justify-between items-center text-xs text-slate-500">
                            <span>Selected: {{ nmos.applySelections.length }}</span>
                            <div class="flex gap-2">
                                <button class="px-3 py-1 border rounded" @click="closeNmosApplyDialog">Cancel</button>
                                <button
                                    class="px-4 py-1 rounded bg-emerald-600 text-white disabled:opacity-50"
                                    :disabled="nmos.applying || nmos.applySelections.length === 0"
                                    @click="applyNmos(nmos.result.flow_id)"
                                >
                                    {{ nmos.applying ? 'Applying...' : 'Apply & Update' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="detailFlow" class="fixed inset-0 bg-black/60 flex items-center justify-center z-40">
                <div class="bg-white rounded shadow-lg w-full max-w-4xl max-h-[80vh] overflow-auto">
                    <div class="flex justify-between items-center px-6 py-4 border-b">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="text-lg font-semibold" v-text="detailFlow ? (detailFlow.display_name || detailFlow.flow_id) : ''"></h3>
                                <span v-if="detailFlow?.locked" class="text-slate-500 text-base leading-none">⚿</span>
                            </div>
                            <p class="text-xs text-slate-500 flex items-center gap-2">
                                flow_id:
                                <span class="font-mono" v-text="detailFlow ? detailFlow.flow_id : ''"></span>
                                <button
                                    class="text-[11px] px-2 py-1 border rounded text-slate-600 hover:bg-slate-100"
                                    @click="copyToClipboard(detailFlow?.flow_id)"
                                >
                                    Copy
                                </button>
                            </p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                class="px-3 py-1 text-xs border rounded"
                                :disabled="nmos.checking"
                                @click="checkNmos(detailFlow.flow_id)"
                            >
                                NMOS Check
                            </button>
                            <button class="px-3 py-1 text-xs border rounded bg-slate-100 text-slate-400 cursor-not-allowed" disabled>
                                NMOS Sync
                            </button>
                            <button class="text-sm text-slate-500" @click="closeDetail">Close</button>
                        </div>
                    </div>
                    <p v-if="nmos.error && nmos.targetFlowId === detailFlow?.flow_id" class="px-6 pt-3 text-xs text-red-600">
                        {{ nmos.error }}
                    </p>
                    <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div
                            v-for="entry in detailEntries"
                            :key="entry[0]"
                            class="border rounded p-3 flex flex-col gap-1"
                            :class="isNmosDiff(entry[0], detailFlow.flow_id) ? 'border-red-400 bg-red-50' : ''"
                        >
                            <p class="text-xs text-slate-500 uppercase tracking-wide" v-text="entry[0]"></p>
                            <p class="font-mono text-xs break-words whitespace-pre-wrap" v-text="entry[1]"></p>
                            <p
                                v-if="isNmosDiff(entry[0], detailFlow.flow_id)"
                                class="text-[11px] text-red-600 font-mono break-words"
                            >
                                NMOS: {{ nmosDiffValue(entry[0])?.nmos ?? '' }}
                            </p>
                        </div>
                        <p v-if="detailEntries.length === 0" class="text-center text-xs text-slate-500">No data.</p>
                    </div>
                </div>
            </div>
        </main>
        </div>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="./main.js"></script>
    <style>
        .toast-fade-enter-active,
        .toast-fade-leave-active {
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
        .toast-fade-enter-from,
        .toast-fade-leave-to {
            opacity: 0;
            transform: translateY(-20px);
        }
    </style>
</body>
</html>
